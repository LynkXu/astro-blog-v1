---
import StatGrid from './StatGrid.astro';
import StatCard from './StatCard.astro';

interface Props {
  type: 'running' | 'cycling';
  stats: any;
}

const { type, stats } = Astro.props;

const currentYear = new Date().getFullYear();
// Create list of years: [current, current-1, ...] available in data
// Also ensure '2025' is there if user specifically requested checking 2025.
const availableYears = Object.keys(stats.years || {}).sort().reverse();
const tabs = [currentYear.toString(), ...availableYears.filter(y => y !== currentYear.toString())];

function toFixedTrim(n: number, digits: number) {
  const s = n.toFixed(digits);
  return s.replace(/\.0+$/, '').replace(/(\.\d*?)0+$/, '$1');
}

function avgKmPerCountText(distText: any, count: any) {
  const c = Number(count) || 0;
  const d = Number(distText) || 0;
  if (c <= 0) return '暂无记录';
  const avg = d / c;
  return `~${toFixedTrim(avg, 1)} km/次`;
}

function paceText(distKmText: any, timeHoursText: any) {
  const distKm = Number(distKmText) || 0;
  const timeHours = Number(timeHoursText) || 0;
  if (distKm <= 0 || timeHours <= 0) return '暂无记录';
  const totalSeconds = timeHours * 3600;
  const secPerKm = totalSeconds / distKm;
  let mm = Math.floor(secPerKm / 60);
  let ss = Math.round(secPerKm - mm * 60);
  if (ss === 60) {
    mm += 1;
    ss = 0;
  }
  const ssText = String(ss).padStart(2, '0');
  return `~${mm}'${ssText}''/km`;
}

// Construct data attribute for client-side
const dataMap = {
  total: {
    dist: stats.cards.totalDistance.value,
    time: stats.cards.totalTime.value,
    count: stats.cards.totalCount?.value,
    distLabel: stats.cards.totalDistance.label,
    distSub: stats.cards.totalDistance.subtext,
    timeSub: stats.cards.totalTime.subtext,
    countSub: stats.cards.totalCount?.subtext,
  },
  ...Object.fromEntries(
    Object.entries(stats.years || {}).map(([year, data]: [string, any]) => [
      year,
      {
        dist: data.distance,
        time: data.time,
        count: data.count,
        distLabel: type === 'running' ? `${year} 跑量` : `${year} 里程`,
        // running: 这里显示“平均速度/配速”，需要随年份重算（而不是使用 total 的常量 subtext）
        distSub: type === 'running' ? paceText(data.distance, data.time) : '本年度累计',
        timeSub: stats.cards.totalTime.subtext,
        countSub: type === 'cycling' ? avgKmPerCountText(data.distance, data.count) : null,
      }
    ])
  )
};

// 当前年份按钮始终存在，但数据可能不存在（例如骑行没有 2026）。
// 如果不存在，就补一个空数据，避免点击时回退到 total 导致显示“错乱”。
const currentYearKey = currentYear.toString();
if (!((dataMap as any)[currentYearKey])) {
  (dataMap as any)[currentYearKey] = {
    dist: '0',
    time: '0',
    count: 0,
    distLabel: type === 'running' ? `${currentYearKey} 跑量` : `${currentYearKey} 里程`,
    distSub: type === 'running' ? '暂无记录' : '本年度累计',
    timeSub: stats.cards.totalTime.subtext,
    countSub: type === 'cycling' ? '暂无记录' : null,
  };
}

// Initial year shown on first paint should match the active switcher button.
// Always default to current year (even if it has no data).
const initialKey = currentYear.toString();
const initialData =
  (dataMap as any)[initialKey] ??
  {
    dist: '0',
    time: '0',
    count: 0,
    distLabel: type === 'running' ? `${initialKey} 跑量` : `${initialKey} 里程`,
    distSub: type === 'running' ? '暂无记录' : '本年度累计',
    timeSub: stats.cards.totalTime.subtext,
    countSub: type === 'cycling' ? '暂无记录' : null,
  };

const idPrefix = `stats-${type}`;

// --- Detail View Logic ---
const monthlyData = Array.isArray(stats.monthly) ? stats.monthly : [];

// Group monthly data by year for easier rendering
// Structure: { '2026': [...], '2025': [...], 'total': [...] }
const monthlyGroups: Record<string, any[]> = {
  total: monthlyData // Total always includes everything
};

// Initialize groups for all tabs
tabs.forEach(year => {
  monthlyGroups[year] = monthlyData.filter(m => m.month.startsWith(year));
});

// Helper to check if a year has any monthly data
const hasMonthlyData = (year: string) => monthlyGroups[year] && monthlyGroups[year].length > 0;
---

<div class="stats-switcher-container">
  <div class="stats-switcher" id={`${idPrefix}-switcher`}>
    <button class={`switcher-btn ${initialKey === currentYear.toString() ? 'active' : ''}`} data-year={currentYear.toString()}>{currentYear}</button>
    {tabs.filter(y => y !== currentYear.toString()).map(y => (
      <button class={`switcher-btn ${initialKey === y ? 'active' : ''}`} data-year={y}>{y}</button>
    ))}
    <button class={`switcher-btn ${initialKey === 'total' ? 'active' : ''}`} data-year="total">全部</button>
  </div>
</div>

<StatGrid>
  <StatCard
    label={initialData.distLabel}
    value={initialData.dist}
    unit={stats.cards.totalDistance.unit}
    subtext={initialData.distSub}
    id={`${idPrefix}-dist-card`}
  />
  <StatCard
    label={stats.cards.totalTime.label}
    value={initialData.time}
    unit={stats.cards.totalTime.unit}
    subtext={initialData.timeSub}
    id={`${idPrefix}-time-card`}
  />
  
  {type === 'running' ? (
    <>
      <StatCard
        label={stats.cards.halfMarathon.label}
        value={stats.cards.halfMarathon.value}
        unit={stats.cards.halfMarathon.unit}
        subtext={stats.cards.halfMarathon.subtext}
      />
      <StatCard
        label={stats.cards.fullMarathon.label}
        value={stats.cards.fullMarathon.value}
        unit={stats.cards.fullMarathon.unit}
        subtext={stats.cards.fullMarathon.subtext}
      />
    </>
  ) : (
    <>
      <StatCard
        label={stats.cards.totalCount.label}
        value={initialData.count ?? stats.cards.totalCount.value}
        unit={stats.cards.totalCount.unit}
        subtext={initialData.countSub ?? stats.cards.totalCount.subtext}
        id={`${idPrefix}-count-card`}
      />
      <StatCard
        label={stats.cards.farthest.label}
        value={stats.cards.farthest.value}
        unit={stats.cards.farthest.unit}
        subtext={stats.cards.farthest.subtext}
      />
    </>
  )}
</StatGrid>

<div class="detail-section" id={`${idPrefix}-detail-section`}>
  {/* Header Title based on type */}
  <h3>{type === 'running' ? '比赛记录' : (type === 'cycling' ? '月度汇总' : '详细数据')}</h3>
  
  {type === 'cycling' && <div class="section-desc">按月统计里程与频次，回顾骑行趋势。</div>}

  {/* Render detail containers for each year + total */}
  {[...tabs, 'total'].map(year => (
    <div 
      class={`detail-group ${year === initialKey ? 'active' : ''}`} 
      data-year={year}
    >
      {type === 'running' ? (
        // Running: Race Records (Placeholder for now as data structure is not yet ready)
        <div class="empty-state">
          {year === 'total' 
            ? '暂无比赛记录（未来将在此更新马拉松赛事成绩）' 
            : `${year} 年暂无比赛记录`}
        </div>
      ) : (
        // Cycling: Monthly Table
        hasMonthlyData(year) ? (
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th align="left">月份</th>
                  <th align="left">距离 (km)</th>
                  <th align="left">次数</th>
                  <th align="left">时长 (h)</th>
                </tr>
              </thead>
              <tbody>
                {monthlyGroups[year].map((row) => (
                  <tr>
                    <td>{row.month}</td>
                    <td>{row.distanceKm}</td>
                    <td>{row.count}</td>
                    <td>{row.movingTimeHours}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="empty-state">
            {year === 'total' 
               ? '暂无月度数据' 
               : `${year} 年暂无月度数据`}
          </div>
        )
      )}
    </div>
  ))}
</div>

<script define:vars={{ dataMap, idPrefix }}>
  const container = document.getElementById(`${idPrefix}-switcher`);
  const detailSection = document.getElementById(`${idPrefix}-detail-section`);

  if (container) {
    const btns = container.querySelectorAll('.switcher-btn');
    
    // Elements to update
    const distVal = document.querySelector(`#${idPrefix}-dist-card .stat-value`);
    const distLabel = document.querySelector(`#${idPrefix}-dist-card .stat-label`);
    const distSub = document.querySelector(`#${idPrefix}-dist-card .stat-sub`);
    const timeVal = document.querySelector(`#${idPrefix}-time-card .stat-value`);
    const timeSub = document.querySelector(`#${idPrefix}-time-card .stat-sub`);
    const countVal = document.querySelector(`#${idPrefix}-count-card .stat-value`); // might be null for running
    const countSub = document.querySelector(`#${idPrefix}-count-card .stat-sub`); // might be null for running

    btns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Toggle active class for buttons
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const year = btn.getAttribute('data-year');
        const data = dataMap[year] || dataMap['total'];

        // Animate/Update values
        if (distVal) distVal.textContent = data.dist;
        if (distLabel) distLabel.textContent = data.distLabel ?? '';
        if (distSub) distSub.textContent = data.distSub ?? '';
        if (timeVal) timeVal.textContent = data.time;
        if (timeSub) timeSub.textContent = data.timeSub ?? '';
        if (countVal && data.count !== undefined) countVal.textContent = data.count;
        if (countSub) countSub.textContent = data.countSub ?? '';

        // Toggle active class for detail groups
        if (detailSection) {
          const groups = detailSection.querySelectorAll('.detail-group');
          groups.forEach(g => {
            if (g.getAttribute('data-year') === year) {
              g.classList.add('active');
            } else {
              g.classList.remove('active');
            }
          });
        }
      });
    });
  }
</script>

<style>
  /* Local variables for theming with fallbacks */
  .stats-switcher-container {
    display: flex;
    justify-content: flex-start;
    margin-bottom: 1.5rem;
    --switcher-bg: var(--code-background-color, #f2f2f2);
    --switcher-border: rgba(0,0,0,0.06);
    --btn-text: var(--gray-color, #999);
    --btn-hover: var(--text-color, #333);
    --btn-active-bg: var(--background-color, #fff);
    --btn-active-text: var(--heading-color, #000);
    --table-border: rgba(0,0,0,0.08);
  }
  
  /* Dark mode overrides using global theme selectors */
  :global([data-theme="dark"]) .stats-switcher-container,
  :global([data-theme="dark"]) .detail-section {
    --switcher-bg: var(--code-background-color, #000);
    --switcher-border: rgba(255,255,255,0.12);
    --btn-text: var(--gray-color, #999);
    --btn-hover: var(--text-color, #ddd);
    --btn-active-bg: var(--background-color, #111);
    --btn-active-text: var(--heading-color, #eee);
    --table-border: rgba(255,255,255,0.12);
  }

  @media (prefers-color-scheme: dark) {
    :global(:root:not([data-theme="light"])) .stats-switcher-container,
    :global(:root:not([data-theme="light"])) .detail-section {
      --switcher-bg: var(--code-background-color, #000);
      --switcher-border: rgba(255,255,255,0.12);
      --btn-text: var(--gray-color, #999);
      --btn-hover: var(--text-color, #ddd);
      --btn-active-bg: var(--background-color, #111);
      --btn-active-text: var(--heading-color, #eee);
      --table-border: rgba(255,255,255,0.12);
    }
  }
  
  .stats-switcher {
    display: inline-flex;
    background: var(--switcher-bg);
    padding: 4px;
    border-radius: 8px;
    gap: 4px;
    border: 1px solid var(--switcher-border);
  }

  .switcher-btn {
    background: transparent;
    border: none;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--btn-text);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .switcher-btn:hover {
    color: var(--btn-hover);
  }

  .switcher-btn.active {
    background: var(--btn-active-bg);
    color: var(--btn-active-text);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-weight: 500;
  }
  
  .detail-section {
    margin-top: 2rem;
  }

  .section-desc {
    margin-bottom: 1rem;
    color: var(--gray-color);
    font-size: 0.9em;
    border-left: 3px solid var(--heading-color);
    padding-left: 0.8rem;
  }

  /* Detail Groups Toggle Logic */
  .detail-group {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }
  
  .detail-group.active {
    display: block;
  }

  .table-wrapper {
    overflow-x: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }
  
  th, td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--table-border, rgba(0,0,0,0.08));
    color: var(--text-color);
  }
  
  th {
    font-weight: 600;
    color: var(--gray-color);
  }

  .empty-state {
    padding: 2rem;
    text-align: center;
    background: var(--code-background-color);
    border-radius: 8px;
    color: var(--gray-color);
    font-size: 0.9em;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
